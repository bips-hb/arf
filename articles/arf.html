<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Adversarial Random Forests ‚Ä¢ arf</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adversarial Random Forests">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">arf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/arf.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bips-hb/arf/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Adversarial Random Forests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bips-hb/arf/blob/main/vignettes/arf.Rmd" class="external-link"><code>vignettes/arf.Rmd</code></a></small>
      <div class="d-none name"><code>arf.Rmd</code></div>
    </div>

    
    
<p>This vignette covers the entire adversarial random forest (ARF)
pipeline, from model training to parameter learning, density estimation,
and data synthesis.</p>
<div class="section level2">
<h2 id="adversarial-training">Adversarial Training<a class="anchor" aria-label="anchor" href="#adversarial-training"></a>
</h2>
<p>The ARF algorithm is an iterative procedure. In the first instance,
we generate synthetic data by independently sampling from the marginals
of each feature and training a random forest (RF) to distinguish
original from synthetic samples. If accuracy is greater than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn><mo>+</mo><mi>Œ¥</mi></mrow><annotation encoding="application/x-tex">0.5 + \delta</annotation></semantics></math>
(where <code>delta</code> is a user-controlled tolerance parameter,
generally set to 0), we create a new dataset by sampling from the
marginals within each leaf and training another RF classifier. The
procedure repeats until original and synthetic samples cannot be
reliably distinguished. With the default <code>verbose = TRUE</code>,
the algorithm will print accuracy at each iteration.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bips-hb/arf" class="external-link">arf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span>, <span class="st">"L'Ecuyer-CMRG"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train ARF</span></span>
<span><span class="va">arf_iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adversarial_rf.html">adversarial_rf</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="co">#&gt; Iteration: 0, Accuracy: 76.09%</span></span>
<span><span class="co">#&gt; Iteration: 1, Accuracy: 40.33%</span></span>
<span><span class="co">#&gt; Warning: executing %dopar% sequentially: no parallel backend registered</span></span></code></pre></div>
<p>The printouts can be turned off by setting
<code>verbose = FALSE</code>. Accuracy is still stored within the
<code>arf</code> object, so you can evaluate convergence after the fact.
The warning appears just once per session. It can be suppressed by
setting <code>parallel = FALSE</code> or registering a parallel backend
(more on this below).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Train ARF with no printouts</span></span>
<span><span class="va">arf_iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adversarial_rf.html">adversarial_rf</a></span><span class="op">(</span><span class="va">iris</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot accuracy against iterations (model converges when accuracy &lt;= 0.5)</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">'Accuracy'</span> <span class="op">=</span> <span class="va">arf_iris</span><span class="op">$</span><span class="va">acc</span>, </span>
<span>                  <span class="st">'Iteration'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">arf_iris</span><span class="op">$</span><span class="va">acc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Iteration</span>, <span class="va">Accuracy</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span> </span></code></pre></div>
<p><img src="arf_files/figure-html/arf2-1.png" width="480"></p>
<p>We find a quick drop in accuracy following the resampling procedure,
as desired. If the ARF has converged, then resulting splits should form
fully factorized leaves, i.e.¬†subregions of the feature space where
variables are locally independent.</p>
<p>ARF convergence is asymptotically guaranteed as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>‚Üí</mo><mi>‚àû</mi></mrow><annotation encoding="application/x-tex">n \rightarrow \infty</annotation></semantics></math>
(see <a href="https://proceedings.mlr.press/v206/watson23a.html" class="external-link">Watson
et al., 2023</a>, Thm. 1). However, this has no implications for finite
sample performance. In practice, we often find that adversarial training
completes in just one or two rounds, but this may not hold for some
datasets. To avoid infinite loops, users can increase the slack
parameter <code>delta</code> or set the <code>max_iters</code> argument
(default = 10). In addition to these failsafes,
<code>adversarial_rf</code> uses early stopping by default
<code>(early_stop = TRUE)</code>, which terminates training if
factorization does not improve from one round to the next. This is
recommended, since discriminator accuracy rarely falls much lower once
it has increased.</p>
<p>For density estimation tasks, we recommend increasing the default
number of trees. We generally use 100 in our experiments, though this
may be suboptimal for some datasets. Likelihood estimates are not very
sensitive to this parameter above a certain threshold, but larger models
incur extra costs in time and memory. We can speed up computations by
registering a parallel backend, in which case ARF training is
distributed across cores using the <code>ranger</code> package. Much
like with <code>ranger</code>, the default behavior of
<code>adversarial_rf</code> is to compute in parallel if possible. How
exactly this is done varies across operating systems. The following code
works on Unix machines.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Register cores - Unix</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Windows requires a different setup.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Register cores - Windows</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>In either case, we can now execute in parallel.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rerun ARF, now in parallel and with more trees</span></span>
<span><span class="va">arf_iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adversarial_rf.html">adversarial_rf</a></span><span class="op">(</span><span class="va">iris</span>, num_trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt; Iteration: 0, Accuracy: 85.67%</span></span>
<span><span class="co">#&gt; Iteration: 1, Accuracy: 40.67%</span></span></code></pre></div>
<p>The result is an object of class <code>ranger</code>, which we can
input to downstream functions.</p>
</div>
<div class="section level2">
<h2 id="parameter-learning">Parameter Learning<a class="anchor" aria-label="anchor" href="#parameter-learning"></a>
</h2>
<p>The next step is to learn the leaf and distribution parameters using
forests for density estimation (FORDE). This function calculates the
coverage, bounds, and pdf/pmf parameters for every variable in every
leaf. This can be an expensive computation for large datasets, as it
requires
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ùí™</mi><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">(</mo><mi>B</mi><mo>‚ãÖ</mo><mi>d</mi><mo>‚ãÖ</mo><mi>n</mi><mo>‚ãÖ</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>n</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}\big(B \cdot d \cdot n \cdot \log(n)\big)</annotation></semantics></math>
operations, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
is the number of trees,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>d</mi><annotation encoding="application/x-tex">d</annotation></semantics></math>
is the data dimensionality, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is the sample size. Once again, the process is parallelized by
default.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute leaf and distribution parameters</span></span>
<span><span class="va">params_iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forde.html">forde</a></span><span class="op">(</span><span class="va">arf_iris</span>, <span class="va">iris</span><span class="op">)</span></span></code></pre></div>
<p>Default behavior is to use a truncated normal distribution for
continuous data (with boundaries given by the tree‚Äôs split parameters)
and a multinomial distribution for categorical data. We find that this
produces stable results in a wide range of settings. You can also use a
uniform distribution for continuous features by setting
<code>family = 'unif'</code>, thereby instantiating a piecewise constant
density estimator.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Recompute with uniform density</span></span>
<span><span class="va">params_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forde.html">forde</a></span><span class="op">(</span><span class="va">arf_iris</span>, <span class="va">iris</span>, family <span class="op">=</span> <span class="st">'unif'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in forde(arf_iris, iris, family = "unif"): Density estimation with</span></span>
<span><span class="co">#&gt; uniform distribution requires finite bounds. Resetting finite_bounds to</span></span>
<span><span class="co">#&gt; "local".</span></span></code></pre></div>
<p>This method tends to perform poorly in practice, and we do not
recommend it. The option is implemented primarily for benchmarking
purposes. Alternative families, e.g.¬†truncated Poisson or beta
distributions, may be useful for certain problems. Future releases will
expand the range of options for the <code>family</code> argument.</p>
<p>The <code>alpha</code> and <code>epsilon</code> arguments allow for
optional regularization of multinomial and uniform distributions,
respectively. These help prevent zero likelihood samples when test data
fall outside the support of training data. The former is a pseudocount
parameter that applies <a href="https://en.wikipedia.org/wiki/Additive_smoothing" class="external-link">Laplace
smoothing</a> within leaves, preventing unobserved values from being
assigned zero probability unless splits explicitly rule them out. In
other words, we impose a flat Dirichlet prior and report posterior
probabilities rather than maximum likelihood estimates. The latter is a
slack parameter on empirical bounds that expands the estimated extrema
for continuous features by a factor of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mi>œµ</mi></mrow><annotation encoding="application/x-tex">1 + \epsilon</annotation></semantics></math>.</p>
<p>Compare the results of our original probability estimates for the
<code>Species</code> variable with those obtained by adding a
pseudocount of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ±</mi><mo>=</mo><mn>0.1</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.1</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Recompute with additive smoothing</span></span>
<span><span class="va">params_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forde.html">forde</a></span><span class="op">(</span><span class="va">arf_iris</span>, <span class="va">iris</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">params_iris</span><span class="op">$</span><span class="va">cat</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;f_idx, variable&gt;</span></span>
<span><span class="co">#&gt;    f_idx variable       val  prob NA_share</span></span>
<span><span class="co">#&gt;    &lt;int&gt;   &lt;char&gt;    &lt;char&gt; &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     1  Species virginica     1        0</span></span>
<span><span class="co">#&gt; 2:     2  Species virginica     1        0</span></span>
<span><span class="co">#&gt; 3:     3  Species virginica     1        0</span></span>
<span><span class="co">#&gt; 4:     4  Species virginica     1        0</span></span>
<span><span class="co">#&gt; 5:     5  Species    setosa     1        0</span></span>
<span><span class="co">#&gt; 6:     6  Species    setosa     1        0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">params_alpha</span><span class="op">$</span><span class="va">cat</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;f_idx, variable&gt;</span></span>
<span><span class="co">#&gt;    f_idx variable        val       prob NA_share</span></span>
<span><span class="co">#&gt;    &lt;int&gt;   &lt;char&gt;     &lt;char&gt;      &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     1  Species  virginica 0.93939394        0</span></span>
<span><span class="co">#&gt; 2:     1  Species     setosa 0.03030303        0</span></span>
<span><span class="co">#&gt; 3:     1  Species versicolor 0.03030303        0</span></span>
<span><span class="co">#&gt; 4:     2  Species  virginica 0.91304348        0</span></span>
<span><span class="co">#&gt; 5:     2  Species     setosa 0.04347826        0</span></span>
<span><span class="co">#&gt; 6:     2  Species versicolor 0.04347826        0</span></span></code></pre></div>
<p>Under Laplace smoothing, extreme probabilities only occur when the
splits explicitly demand it. Otherwise, all values shrink toward a
uniform prior. Note that these two data tables may not have exactly the
same rows, as we omit zero probability events to conserve memory.
However, we can verify that probabilities sum to unity for each
leaf-variable combination.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sum probabilities</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">params_iris</span><span class="op">$</span><span class="va">cat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">f_idx</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">V1</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;       1       1       1       1       1       1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">params_alpha</span><span class="op">$</span><span class="va">cat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">f_idx</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">V1</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;       1       1       1       1       1       1</span></span></code></pre></div>
<p>The <code>forde</code> function outputs a list of length 6, with
entries for (1) continuous features; (2) categorical features; (3) leaf
parameters; (4) variable metadata; (5) factor levels; and (6) data input
class.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params_iris</span></span>
<span><span class="co">#&gt; $cnt</span></span>
<span><span class="co">#&gt; Key: &lt;f_idx, variable&gt;</span></span>
<span><span class="co">#&gt;        f_idx     variable   min   max       mu      sigma NA_share</span></span>
<span><span class="co">#&gt;        &lt;int&gt;       &lt;char&gt; &lt;num&gt; &lt;num&gt;    &lt;num&gt;      &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt;     1:     1 Petal.Length  -Inf   Inf 5.933333 0.20816660        0</span></span>
<span><span class="co">#&gt;     2:     1  Petal.Width  2.45   Inf 2.500000 0.01041469        0</span></span>
<span><span class="co">#&gt;     3:     1 Sepal.Length  -Inf   Inf 6.733333 0.45092498        0</span></span>
<span><span class="co">#&gt;     4:     1  Sepal.Width  -Inf   Inf 3.400000 0.17320508        0</span></span>
<span><span class="co">#&gt;     5:     2 Petal.Length  -Inf   Inf 5.250000 0.21213203        0</span></span>
<span><span class="co">#&gt;    ---                                                            </span></span>
<span><span class="co">#&gt; 10484:  2621  Sepal.Width  3.30  3.45 3.400000 0.02209289        0</span></span>
<span><span class="co">#&gt; 10485:  2622 Petal.Length  -Inf  4.20 1.400000 0.10000000        0</span></span>
<span><span class="co">#&gt; 10486:  2622  Petal.Width  -Inf  0.25 0.200000 0.03124407        0</span></span>
<span><span class="co">#&gt; 10487:  2622 Sepal.Length  4.65  5.55 5.266667 0.20816660        0</span></span>
<span><span class="co">#&gt; 10488:  2622  Sepal.Width  3.45  3.55 3.500000 0.02082938        0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $cat</span></span>
<span><span class="co">#&gt; Key: &lt;f_idx, variable&gt;</span></span>
<span><span class="co">#&gt;       f_idx variable        val      prob NA_share</span></span>
<span><span class="co">#&gt;       &lt;int&gt;   &lt;char&gt;     &lt;char&gt;     &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:     1  Species  virginica 1.0000000        0</span></span>
<span><span class="co">#&gt;    2:     2  Species  virginica 1.0000000        0</span></span>
<span><span class="co">#&gt;    3:     3  Species  virginica 1.0000000        0</span></span>
<span><span class="co">#&gt;    4:     4  Species  virginica 1.0000000        0</span></span>
<span><span class="co">#&gt;    5:     5  Species     setosa 1.0000000        0</span></span>
<span><span class="co">#&gt;   ---                                             </span></span>
<span><span class="co">#&gt; 2919:  2618  Species versicolor 0.4615385        0</span></span>
<span><span class="co">#&gt; 2920:  2619  Species     setosa 1.0000000        0</span></span>
<span><span class="co">#&gt; 2921:  2620  Species     setosa 1.0000000        0</span></span>
<span><span class="co">#&gt; 2922:  2621  Species     setosa 1.0000000        0</span></span>
<span><span class="co">#&gt; 2923:  2622  Species     setosa 1.0000000        0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $forest</span></span>
<span><span class="co">#&gt; Key: &lt;tree, leaf&gt;</span></span>
<span><span class="co">#&gt;       f_idx  tree  leaf        cvg</span></span>
<span><span class="co">#&gt;       &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:     1     1     6 0.02000000</span></span>
<span><span class="co">#&gt;    2:     2     1    10 0.01333333</span></span>
<span><span class="co">#&gt;    3:     3     1    13 0.04000000</span></span>
<span><span class="co">#&gt;    4:     4     1    16 0.03333333</span></span>
<span><span class="co">#&gt;    5:     5     1    21 0.02000000</span></span>
<span><span class="co">#&gt;   ---                             </span></span>
<span><span class="co">#&gt; 2618:  2618   100    49 0.08666667</span></span>
<span><span class="co">#&gt; 2619:  2619   100    57 0.02000000</span></span>
<span><span class="co">#&gt; 2620:  2620   100    58 0.04666667</span></span>
<span><span class="co">#&gt; 2621:  2621   100    60 0.04000000</span></span>
<span><span class="co">#&gt; 2622:  2622   100    61 0.02000000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta</span></span>
<span><span class="co">#&gt;        variable   class    family decimals</span></span>
<span><span class="co">#&gt;          &lt;char&gt;  &lt;char&gt;    &lt;char&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1: Sepal.Length numeric truncnorm        1</span></span>
<span><span class="co">#&gt; 2:  Sepal.Width numeric truncnorm        1</span></span>
<span><span class="co">#&gt; 3: Petal.Length numeric truncnorm        1</span></span>
<span><span class="co">#&gt; 4:  Petal.Width numeric truncnorm        1</span></span>
<span><span class="co">#&gt; 5:      Species  factor  multinom       NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $levels</span></span>
<span><span class="co">#&gt;    variable        val</span></span>
<span><span class="co">#&gt;      &lt;char&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:  Species     setosa</span></span>
<span><span class="co">#&gt; 2:  Species versicolor</span></span>
<span><span class="co">#&gt; 3:  Species  virginica</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $input_class</span></span>
<span><span class="co">#&gt; [1] "data.frame"</span></span></code></pre></div>
<p>These parameters can be used for a variety of downstream tasks, such
as likelihood estimation and data synthesis.</p>
</div>
<div class="section level2">
<h2 id="likelihood-estimation">Likelihood Estimation<a class="anchor" aria-label="anchor" href="#likelihood-estimation"></a>
</h2>
<p>To calculate log-likelihoods, we pass <code>params</code> on to the
<code>lik</code> function, along with the data whose likelihood we wish
to evaluate. For <em>total evidence</em> queries (i.e., those spanning
all variables and no conditioning events), it is faster to also include
<code>arf</code> in the function call.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute likelihood under truncated normal and uniform distributions</span></span>
<span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lik.html">lik</a></span><span class="op">(</span><span class="va">params_iris</span>, <span class="va">iris</span>, arf <span class="op">=</span> <span class="va">arf_iris</span><span class="op">)</span></span>
<span><span class="va">ll_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lik.html">lik</a></span><span class="op">(</span><span class="va">params_unif</span>, <span class="va">iris</span>, arf <span class="op">=</span> <span class="va">arf_iris</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare average negative log-likelihood (lower is better)</span></span>
<span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ll</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3196718</span></span>
<span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ll_unif</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -7.291452</span></span></code></pre></div>
<p>Note that the piecewise constant estimator does considerably worse in
this experiment.</p>
<p>The <code>lik</code> function can also be used to compute the
likelihood of some <em>partial state</em>, i.e.¬†a setting in which some
but not all variable values are specified. Let‚Äôs take a look at that
iris dataset:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">#&gt; 1          5.1         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 2          4.9         3.0          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 3          4.7         3.2          1.3         0.2  setosa</span></span>
<span><span class="co">#&gt; 4          4.6         3.1          1.5         0.2  setosa</span></span>
<span><span class="co">#&gt; 5          5.0         3.6          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 6          5.4         3.9          1.7         0.4  setosa</span></span></code></pre></div>
<p>Say we want to calculate sample likelihoods using only continuous
data. That is, we provide values for the first four variables but
exclude the fifth. In this case, the model will have to marginalize over
<code>Species</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute likelihoods after marginalizing over Species</span></span>
<span><span class="va">iris_without_species</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span>, <span class="op">-</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">ll_cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lik.html">lik</a></span><span class="op">(</span><span class="va">params_iris</span>, <span class="va">iris_without_species</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare results</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Total <span class="op">=</span> <span class="va">ll</span>, Partial <span class="op">=</span> <span class="va">ll_cnt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Total</span>, <span class="va">Partial</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="arf_files/figure-html/iris2-1.png" width="480"></p>
<p>We find that likelihoods are almost identical, with slightly higher
likelihood on average for partial samples. This is expected, since they
have less variation to model.</p>
<p>In this example, we have used the same data throughout. This may lead
to overfitting. With sufficient data, it is preferable to use a training
set for <code>adversarial_rf</code>, a validation set for
<code>forde</code>, and a test set for <code>lik</code>. Alternatively,
we can set the <code>oob</code> argument to <code>TRUE</code> for either
of the latter two functions, in which case computations are performed
only on out-of-bag (OOB) data. These are samples that are randomly
excluded from a given tree due to the bootstrapping subroutine of the RF
classifier. Note that this only works when the dataset <code>x</code>
passed to <code>forde</code> or <code>lik</code> is the same one used to
train the <code>arf</code>. Recall that a sample‚Äôs probability of being
excluded from a single tree is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>‚àí</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚âà</mo><mn>0.368</mn></mrow><annotation encoding="application/x-tex">\exp(-1) \approx 0.368</annotation></semantics></math>.
When using <code>oob = TRUE</code>, be sure to include enough trees so
that every observation is likely to be OOB at least a few times.</p>
</div>
<div class="section level2">
<h2 id="data-synthesis">Data Synthesis<a class="anchor" aria-label="anchor" href="#data-synthesis"></a>
</h2>
<p>For this experiment, we use the <code>smiley</code> simulation from
the <code>mlbench</code> package, which allows for easy visual
assessment. We draw a training set of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">n = 1000</annotation></semantics></math>
and simulate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1000</mn><annotation encoding="application/x-tex">1000</annotation></semantics></math>
synthetic datapoints. Resulting data are plotted side by side.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate training data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mlbench</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mlbench/man/mlbench.smiley.html" class="external-link">mlbench.smiley</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">classes</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'X'</span>, <span class="st">'Y'</span>, <span class="st">'Class'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit ARF</span></span>
<span><span class="va">arf_smiley</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adversarial_rf.html">adversarial_rf</a></span><span class="op">(</span><span class="va">x</span>, mtry <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Iteration: 0, Accuracy: 84.35%</span></span>
<span><span class="co">#&gt; Iteration: 1, Accuracy: 39.5%</span></span>
<span></span>
<span><span class="co"># Estimate parameters</span></span>
<span><span class="va">params_smiley</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forde.html">forde</a></span><span class="op">(</span><span class="va">arf_smiley</span>, <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate data</span></span>
<span><span class="va">synth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forge.html">forge</a></span><span class="op">(</span><span class="va">params_smiley</span>, n_synth <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    1000 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ X    : num  -0.841 -0.911 -0.91 -0.743 -0.863 ...</span></span>
<span><span class="co">#&gt;  $ Y    : num  0.874 0.926 1.051 0.918 1.157 ...</span></span>
<span><span class="co">#&gt;  $ Class: Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">synth</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    1000 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ X    : num  -0.3742 -0.0897 0.0322 0.0271 -0.8529 ...</span></span>
<span><span class="co">#&gt;  $ Y    : num  -0.786 0.371 0.548 0.546 -0.247 ...</span></span>
<span><span class="co">#&gt;  $ Class: Factor w/ 4 levels "1","2","3","4": 4 3 3 3 4 4 3 2 3 3 ...</span></span>
<span></span>
<span><span class="co"># Put it all together</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="st">'Original'</span></span>
<span><span class="va">synth</span><span class="op">$</span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="st">'Synthetic'</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">synth</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot results</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, color <span class="op">=</span> <span class="va">Class</span>, shape <span class="op">=</span> <span class="va">Class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Data</span><span class="op">)</span></span></code></pre></div>
<p><img src="arf_files/figure-html/smiley-1.png" width="768"></p>
<p>The general shape is clearly recognizable, even if some stray samples
are evident and borders are not always crisp. This can be improved with
more training data.</p>
</div>
<div class="section level2">
<h2 id="conditioning">Conditioning<a class="anchor" aria-label="anchor" href="#conditioning"></a>
</h2>
<p>ARFs can also be used to compute likelihoods and synthesize data
under conditioning events that specify values or ranges for input
features. For instance, say we want to evaluate the likelihood of
samples from the <code>iris</code> dataset under the condition that
<code>Species = 'setosa'</code>. There are several ways to encode
evidence, but the simplest is to pass a partial observation.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute conditional likelihoods</span></span>
<span><span class="va">evi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Species <span class="op">=</span> <span class="st">'setosa'</span><span class="op">)</span></span>
<span><span class="va">ll_conditional</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lik.html">lik</a></span><span class="op">(</span><span class="va">params_iris</span>, query <span class="op">=</span> <span class="va">iris_without_species</span>, evidence <span class="op">=</span> <span class="va">evi</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare NLL across species (shifting to positive range for visualization)</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">iris</span></span>
<span><span class="va">tmp</span><span class="op">$</span><span class="va">NLL</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">ll_conditional</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ll_conditional</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Species</span>, <span class="va">NLL</span>, fill <span class="op">=</span> <span class="va">Species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Negative Log-Likelihood'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 11 rows containing non-finite outside the scale range</span></span>
<span><span class="co">#&gt; (`stat_boxplot()`).</span></span></code></pre></div>
<p><img src="arf_files/figure-html/conditional-1.png" width="480"></p>
<p>As expected, measurements for non-setosa samples appear much less
likely under this conditioning event.</p>
<p>The partial observation method of passing evidence requires users to
specify unique feature values for each conditioning variable. A more
flexible alternative is to construct a data frame of conditioning
events, potentially including inequalities. For example, we may want to
calculate the likelihood of samples given that
<code>Species = 'setosa'</code> and
<code>Petal.Width &gt; 0.3</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Data frame of conditioning events</span></span>
<span><span class="va">evi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Species <span class="op">=</span> <span class="st">"setosa"</span>, </span>
<span>                  Petal.Width <span class="op">=</span> <span class="st">"&gt;0.3"</span><span class="op">)</span></span>
<span><span class="va">evi</span></span>
<span><span class="co">#&gt;   Species Petal.Width</span></span>
<span><span class="co">#&gt; 1  setosa        &gt;0.3</span></span></code></pre></div>
<p>We can also define intervals:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Species <span class="op">=</span> <span class="st">"setosa"</span>, </span>
<span>                  Petal.Width <span class="op">=</span> <span class="st">"(0.3,0.5)"</span><span class="op">)</span></span>
<span><span class="va">evi</span></span>
<span><span class="co">#&gt;   Species Petal.Width</span></span>
<span><span class="co">#&gt; 1  setosa   (0.3,0.5)</span></span></code></pre></div>
<p>Resulting likelihoods will be computed on the condition that all
queries are drawn from setosa flowers with petal width on the interval
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.3</mn><mo>,</mo><mn>0.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(0.3, 0.5)</annotation></semantics></math>.</p>
<p>A final method for passing evidence is to directly compute a
posterior distribution on leaves. This could be useful for particularly
complex conditioning events for which there is currently no inbuilt
interface, such as polynomial constraints or arbitrary propositions in
disjunctive normal form. In this case, we just require a data frame with
columns for <code>f_idx</code> and <code>wt</code>. If the latter does
not sum to unity, the distribution will be normalized with a
warning.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Drawing random weights</span></span>
<span><span class="va">evi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>f_idx <span class="op">=</span> <span class="va">params_iris</span><span class="op">$</span><span class="va">forest</span><span class="op">$</span><span class="va">f_idx</span>,</span>
<span>                  wt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">params_iris</span><span class="op">$</span><span class="va">forest</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">evi</span><span class="op">$</span><span class="va">wt</span> <span class="op">&lt;-</span> <span class="va">evi</span><span class="op">$</span><span class="va">wt</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">evi</span><span class="op">$</span><span class="va">wt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">evi</span><span class="op">)</span></span>
<span><span class="co">#&gt;   f_idx           wt</span></span>
<span><span class="co">#&gt; 1     1 4.483113e-04</span></span>
<span><span class="co">#&gt; 2     2 3.997981e-05</span></span>
<span><span class="co">#&gt; 3     3 2.888576e-05</span></span>
<span><span class="co">#&gt; 4     4 8.726013e-04</span></span>
<span><span class="co">#&gt; 5     5 4.433602e-04</span></span>
<span><span class="co">#&gt; 6     6 3.536210e-05</span></span></code></pre></div>
<p>Each of these methods can be used for conditional sampling as
well.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate class-conditional data for smiley example</span></span>
<span><span class="va">evi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Class <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">synth2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forge.html">forge</a></span><span class="op">(</span><span class="va">params_smiley</span>, n_synth <span class="op">=</span> <span class="fl">250</span>, evidence <span class="op">=</span> <span class="va">evi</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Put it all together</span></span>
<span><span class="va">synth2</span><span class="op">$</span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="st">'Synthetic'</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">synth2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot results</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, color <span class="op">=</span> <span class="va">Class</span>, shape <span class="op">=</span> <span class="va">Class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Data</span><span class="op">)</span></span></code></pre></div>
<p><img src="arf_files/figure-html/smiley2-1.png" width="768"></p>
<p>By conditioning on <code>Class = 4</code>, we restrict our sampling
to the smile itself, rather than eyes or nose.</p>
<p>Computing conditional expectations is similarly straightforward.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/expct.html">expct</a></span><span class="op">(</span><span class="va">params_smiley</span>, evidence <span class="op">=</span> <span class="va">evi</span><span class="op">)</span></span>
<span><span class="co">#&gt;             X          Y</span></span>
<span><span class="co">#&gt; 1 -0.01177414 -0.6728099</span></span></code></pre></div>
<p>These are the average
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>,</mo><mi>Y</mi></mrow><annotation encoding="application/x-tex">X, Y</annotation></semantics></math>
coordinates for the smile above.</p>
</div>
<div class="section level2">
<h2 id="data-imputation">Data imputation<a class="anchor" aria-label="anchor" href="#data-imputation"></a>
</h2>
<p>ARFs can be used to impute missing values in datasets. This can be
done either on a one-shot basis, in which case we plug in the
(conditional) expectation of the feature(s) with missing values; or as a
multiple imputation routine, in which case we sample values from the
relevant (conditional) distribution.</p>
<p>For instance, consider the palmer penguins dataset, which includes
several missing values.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load palmer penguins dataset</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://allisonhorst.github.io/palmerpenguins/" class="external-link">palmerpenguins</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'palmerpenguins'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:datasets':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     penguins, penguins_raw</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">penguins</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 √ó 8</span></span></span>
<span><span class="co">#&gt;   species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Adelie  Torgersen           39.1          18.7               181        <span style="text-decoration: underline;">3</span>750</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Adelie  Torgersen           39.5          17.4               186        <span style="text-decoration: underline;">3</span>800</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Adelie  Torgersen           40.3          18                 195        <span style="text-decoration: underline;">3</span>250</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Adelie  Torgersen           <span style="color: #BB0000;">NA</span>            <span style="color: #BB0000;">NA</span>                  <span style="color: #BB0000;">NA</span>          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Adelie  Torgersen           36.7          19.3               193        <span style="text-decoration: underline;">3</span>450</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Adelie  Torgersen           39.3          20.6               190        <span style="text-decoration: underline;">3</span>650</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ‚Ñπ 2 more variables: sex &lt;fct&gt;, year &lt;int&gt;</span></span></span></code></pre></div>
<p>We can fill in the NA‚Äôs in row 4 with their expected value,
conditional on the non-NA values (<code>species</code> and
<code>island</code>) as follows:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Single imputation</span></span>
<span><span class="va">penguins_imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">penguins</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">penguins_imp</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 √ó 8</span></span></span>
<span><span class="co">#&gt;   species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Adelie  Torgersen           39.1          18.7               181        <span style="text-decoration: underline;">3</span>750</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Adelie  Torgersen           39.5          17.4               186        <span style="text-decoration: underline;">3</span>800</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Adelie  Torgersen           40.3          18                 195        <span style="text-decoration: underline;">3</span>250</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Adelie  Torgersen           39            18.5               189        <span style="text-decoration: underline;">3</span>717</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Adelie  Torgersen           36.7          19.3               193        <span style="text-decoration: underline;">3</span>450</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Adelie  Torgersen           39.3          20.6               190        <span style="text-decoration: underline;">3</span>650</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ‚Ñπ 2 more variables: sex &lt;fct&gt;, year &lt;int&gt;</span></span></span></code></pre></div>
<p>Alternatively, we can perform multiple imputation to get a better
sense of the range of plausible values in these conditional
distributions.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multiple imputation</span></span>
<span><span class="va">penguins_multiple_imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">penguins</span>, m <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check the distribution of bill_length_mm for sample 4</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">penguins_multiple_imp</span>, <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="va">dat</span><span class="op">$</span><span class="va">bill_length_mm</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">tmp</span>, breaks <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p><img src="arf_files/figure-html/imp3-1.png" width="576"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marvin N. Wright, David S. Watson, Kristin Blesch, Jan Kapar.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
